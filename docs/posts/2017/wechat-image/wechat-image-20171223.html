<!DOCTYPE html>
<html lang="zh">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>全自动无手工干预实现“朋友圈@微信官方头像添加圣诞帽”的解决方案</title>

        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/github.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="临近圣诞,朋友圈在玩”@微信官方，请给我一顶圣诞帽”的游戏.虽然很多人发了但是并没有给”戴帽”,而是手工换了一个头像.从技术看,这个自动”戴帽”能成吗?">

        <meta name="author" content="spk xu">

        <meta name="tags" content="大数据 技术">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="大嘴的嘴bu大">

	<meta property="og:type" content="article">
            <meta property="article:author" content="/author/spk-xu.html">
	<meta property="og:url" content="/posts/2017/wechat-image/wechat-image-20171223.html">
	<meta property="og:title" content="全自动无手工干预实现“朋友圈@微信官方头像添加圣诞帽”的解决方案">
	<meta property="article:published_time" content="2017-12-23 00:00:00+08:00">
            <meta property="og:description" content="临近圣诞,朋友圈在玩”@微信官方，请给我一顶圣诞帽”的游戏.虽然很多人发了但是并没有给”戴帽”,而是手工换了一个头像.从技术看,这个自动”戴帽”能成吗?">

            <meta property="og:image" content="/theme/images/post-bg.jpg">
</head>

<body class="article-wechat-image">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">94geek.com</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                        <li><a href="/pages/about.html">About</a></li>
                        <li><a href="/pages/sharing.html">Sharing</a></li>
                        <li><a href="/pages/follow.html">Follow</a></li>
                        <li><a href="/files/linuxc/main.htm" target="_blank">Linux C函数</a></li>

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/theme/images/post-bg.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>全自动无手工干预实现“朋友圈@微信官方头像添加圣诞帽”的解决方案</h1>
                        <span class="meta">Posted by
                                <a href="/author/spk-xu.html">spk xu</a>
                             on Sat 23 December 2017
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>首先我声明：我的主要目的是来科普的，请叫我雷锋！   </p>
<p>起因我就不多说了，相信大家都已经被微信朋友圈内“@微信官方，请给我一顶圣诞帽”刷屏了！如图：<br>
<img alt="001-c" src="001.jpeg"><br>
但结果........望穿秋水!</p>
<p>诚然，微信没有实现这个功能。    </p>
<p>本来就知道是恶作剧，我自己也在群里玩。作为技术人员，虽然稍微的想了一下技术方案，但是也没深究。原本这件事情就在嘻嘻哈哈中过去了，但下午看到CSDN技术头条的一篇推送，主要讲述了“朋友圈@微信官方头像添加圣诞帽”是无法实现的，原因......吧啦吧啦吧啦吧啦........！哎，好歹也是技术社区，怎么说也去知乎啥的发个帖，怎么就引用了娱乐版的“悟空问答”呢？</p>
<p>虽然微信没这个功能，但并不代表实现不了！在现有的技术环境下，这点需求都实现不了也未免太看不起我们程序员了吧？！哎，难得星期天放个假，还是一个大晴天，我还不闲着非要较个真？这么简单的功能无法实现？我终于知道为啥很多公司的产品经理和程序员之间一直水火不容了。<br>
<img alt="xxx-c" src="002.jpeg"></p>
<p>废话不说了，作为一个“好人”，重点还是我们的“科普大业”：怎么样全自动无手工干预的实现“朋友圈@微信官方头像添加圣诞帽”。</p>
<p>首先，我们先变身为产品，分析需求，如下：<br>
<img alt="006-c" src="006.png"></p>
<p>从上图可以看出：“@”是发动者，头像更变是最后的结果。对于程序员来说，需要处理的问题点有几个：  <br>
1. 如何知道用户发起来需要戴圣诞帽的要求；     <br>
2. 如何识别出用户头像图片中的头部位置及其走向，然后尽可能正确的加上圣诞帽；      <br>
3. 如何通知微信程序更新最新头像；    </p>
<p>首先，我们来解决第一个难点： 如何知道用户发起需要戴圣诞帽的要求？    <br>
用户发一条朋友圈，微信服务器可以完整的得到该朋友圈的内容，所以微信后台可以对其进行内容解析。只要解析到朋友圈内容中带有“@微信官方”并且内容是“加/戴圣诞帽”相关的，就将该条朋友圈看做是用户需要更改头像。在技术上，我们将其视为给微信发送了一个通知，考虑到朋友圈的发送量和改变图片的实时性需求，稍微延迟一点更改头像也没有特别大的关系，所以将处理头像设计成异步模式，最简单的办法就是将通知放入队列，缓存起来。架构图如下：<br>
<img alt="007-c" src="007.png"></p>
<p>第二步：解决图片识别问题。   <br>
鉴于头像图片识别头部的需求，我们不需要太过于精确，所以也没有必要大张旗鼓的使用很多的AI脸部识别技术（PS：当然有更好），目前开源的项目中opencv即可解决识别问题。opencv可以识别出人脸在图片中位置，将其用坐标的形式“框”起来。考虑到有些用户头像的头部有干扰项：比如头部正好是黑色背景、头像中的人是光头......，可以适当的增加一些抗干扰的考虑项；如果要求更高一些，还可以根据眼睛、鼻子、耳朵等头部特征将头部的走向（防止有歪头的）大体计算清楚。这样在得到头部大体大小、坐标、走向的情况下，适当的调整圣诞帽的大小、坐标、走向，合并成一张图片即可；    </p>
<p>最后：通知微信更新最新头像。  <br>
微信作为一个社交产品，它肯定会考虑加圣诞帽这个需求的时间效应：圣诞帽头像严格意义上说是具有极强时间效应的，所以这个头像存在的时间很短。用户更改头像的初衷并不是出于真心的喜欢，而只是图新鲜，2-5天度过圣诞节后即没用了。所以微信没必要真正的去更改用户的头像，这也就意味着我们根本不需要更改任何数据库的操作，我们直接从原头像的基础上更改，将更改好的图片使用原来头像的文件名推入缓存系统、并且通知微信app更新即可。只要保证在2-5之内头像存在就可以完成任务。当然，如果需要永久保留图片，这就增加数据库标志位字段，然后将加好帽子的图片存入到图片服务器，并且更新缓存服务器的头像图片；</p>
<p>综上所述，整套架构如下所示：<br>
<img alt="008-c" src="008.png"></p>
<p>整个架构图都画出来，但是肯定还有很多的同学会懵逼，竟然不把生成的图片都存储下来？好吧，顺便也科普一下行业内存储图片和处理图片的常用方案。  <br>
业内处理图片有一个不成文的规定：<strong> 存原图，给效果图。</strong> 展开来说就是：<br>
<strong> 程序在存储用户上传图片的时候尽量不处理或者少处理用户的图片，等到用户获取的时候再由程序根据当时的需求给出不同的图片。 </strong></p>
<p>我们最常见的图片操作：加水印、裁剪图片、缩放图片、压缩图片大小......，很多时候我们都在上传的时候解决了。这种方案不是不可以，但是并不好。不好的地方主要有2个：<br>
1. 浪费存储空间。上传的时候进行处理，也就意味着程序要存储一张原图，还有n张效果图。这就是存储可能被扩大了n倍；    <br>
2. 扩展难。目前的业务需求图片是200<em>200；过了3个月，业务方需要400</em>400；又过了2个月，业务方又需要一个300*300的......，纵使我们新需求可以通过更改代码来解决，老图片是不是还要创建一个job来遍历的跑一下才行？    </p>
<p>所以，图片处理正确的做法应该是：在用户获取图片的时候交给图片的http服务器处理。这种解决方案会在一定程度上增加http服务器的压力，但我们可以使用varlish/squid/cdn等成熟的缓存系统将其做到“尽可能的一次写N次读”。图片只有在第一次被访问的时候需要图片http服务器对其进行处理，以后只要这张图片不过期/不被回收，这张图片一直存在于缓存中，根据反向代理原理，请求在缓存处已经获取文件，故不会对图片http产生任何压力。虽然技术实现难度有所增加，但是却解决上面提到的2个最主要的问题。</p>
<p>注：以上方案纯属大体方向和个人揣测，实践中还需要再根据具体的业务做具体的调整。<br>
       如有雷同，纯属巧合！</p>
    </article>

        <div class="tags">
            <p>tags: <a href="/tag/da-shu-ju-ji-zhu.html">大数据 技术</a></p>
        </div>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://github.com/xvhfeng" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="mailto:xvhfeng@126.com">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>. <br />        &copy;  spk xu
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>


    <script type="text/javascript">
        $(document).ready(function() {
            //为超链接加上target='_blank'属性
            $('a').each(function() {
                var href = $(this).attr('href');
                var title = $(this).attr('title');
                if(href && title){
                    var target = $(this).attr('target')
                    if(!target && !title.startsWith("Permalink to")) {
                        $(this).attr('target', '_blank');
                    }
                }
            });
            $('img').each(function() {
                var title = $(this).attr('title');
                var href = $(this).attr('src');
                if(href && title){
                    if(href && title.startsWith("Show->")) {
                        $(this).wrap("<center></center>");
                    }
                }
            });
        });
    </script>

</body>

</html>